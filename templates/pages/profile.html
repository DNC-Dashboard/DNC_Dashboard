{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Nomad — Profile {% endblock title %}
{% block bodyclass %} hold-transition sidebar-mini {% endblock bodyclass %}

{% block content %}
<div class="content-wrapper">
  <!-- Header -->
  <section class="content-header p-0" style="border-bottom: 1px solid rgba(0,0,0,.06);">
    <div class="position-relative">
      <img src="{% static 'dist/img/cover-1.jpg' %}" alt="Cover" style="width:100%; height:220px; object-fit:cover;">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <!-- Avatar + quick actions -->
            <div class="d-flex align-items-end" style="margin-top:-64px;">
              <img id="pfp" class="img-circle elevation-3 mr-3" src="{% static 'dist/img/avatar.png' %}" alt="Avatar" style="width:128px; height:128px; object-fit:cover; border:4px solid #fff;">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                  <h2 class="mb-0" id="display-name">Nomad</h2>
                  <span class="badge badge-primary ml-2" id="headline">Software Developer</span>
                </div>
                <div class="text-muted" id="username">@nomad</div>
                <div class="mt-2">
                  <span class="mr-3"><i class="far fa-user"></i> <span id="followers-count">0</span> Followers</span>
                  <span class="mr-3"><i class="far fa-user"></i> <span id="following-count">0</span> Following</span>
                  <span class="mr-3"><i class="far fa-play-circle"></i> <span id="courses-count">0</span> Courses</span>
                </div>
              </div>
              <div class="text-right mb-2">
                <button class="btn btn-primary" id="btn-follow"><i class="fas fa-user-plus mr-1"></i><span>Follow</span></button>
                <button class="btn btn-outline-secondary" id="btn-edit-profile"><i class="fas fa-user-cog mr-1"></i>Edit Profile</button>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </div>
  </section>

  <!-- Tabs -->
  <section class="content pt-3">
    <div class="container-fluid">
      <ul class="nav nav-pills mb-3" id="profile-tabs">
        <li class="nav-item"><a class="nav-link active" data-tab="overview" href="#"><i class="fas fa-home mr-1"></i>Overview</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="courses" href="#"><i class="fas fa-graduation-cap mr-1"></i>Courses</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="following" href="#"><i class="fas fa-user-friends mr-1"></i>Following</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="activity" href="#"><i class="fas fa-stream mr-1"></i>Activity</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="about" href="#"><i class="fas fa-id-card mr-1"></i>About</a></li>
      </ul>

      <!-- Overview -->
      <div id="tab-overview">
        <div class="row">
          <!-- Left: Bio & Links -->
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header"><h3 class="card-title mb-0">Bio</h3></div>
              <div class="card-body">
                <p id="bio" class="mb-2 text-muted">Curious builder crafting delightful software experiences. Coffee-powered. Remote-first.</p>
                <div class="mb-2"><i class="fas fa-map-marker-alt text-muted mr-2"></i><span id="location">Earth</span></div>
                <div class="mb-2"><i class="fas fa-link text-muted mr-2"></i><a id="website" href="#" target="_blank" rel="noopener">https://nomad.dev</a></div>
                <div class="mb-2"><i class="fab fa-github text-muted mr-2"></i><a id="github" href="#" target="_blank" rel="noopener">github.com/nomad</a></div>
                <div><i class="fab fa-x-twitter text-muted mr-2"></i><a id="twitter" href="#" target="_blank" rel="noopener">@nomad</a></div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3 class="card-title mb-0">Skills</h3></div>
              <div class="card-body" id="skills-wrap">
                <!-- Chips injected -->
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3 class="card-title mb-0">Highlights</h3></div>
              <div class="card-body">
                <ul class="list-unstyled mb-0">
                  <li class="mb-2"><i class="far fa-check-circle text-success mr-2"></i> 12+ shipped products</li>
                  <li class="mb-2"><i class="far fa-check-circle text-success mr-2"></i> OSS contributor (tooling & DX)</li>
                  <li class="mb-2"><i class="far fa-check-circle text-success mr-2"></i> Mentor @ RemoteFirst</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Right: Featured / Timeline -->
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header d-flex align-items-center justify-content-between">
                <h3 class="card-title mb-0"><i class="far fa-star mr-2 text-warning"></i>Featured Courses</h3>
                <button class="btn btn-sm btn-outline-primary" id="btn-add-course"><i class="fas fa-plus mr-1"></i>New Course</button>
              </div>
              <div class="card-body">
                <div class="row" id="featured-courses">
                  <!-- Course cards injected -->
                </div>
                <div class="text-right">
                  <a href="#" class="small" data-tab-jump="courses">See all courses →</a>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3 class="card-title mb-0"><i class="fas fa-stream mr-2"></i>Recent Activity</h3></div>
              <div class="card-body p-0">
                <ul class="products-list product-list-in-card pl-2 pr-2" id="activity-list">
                  <!-- Activity items injected -->
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Courses -->
      <div id="tab-courses" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <span class="badge badge-info" id="courses-count-badge">0 courses</span>
          </div>
          <div>
            <button class="btn btn-primary" id="btn-add-course-2"><i class="fas fa-plus mr-1"></i>New Course</button>
          </div>
        </div>
        <div class="row" id="courses-grid">
          <!-- All courses injected -->
        </div>
      </div>

      <!-- Following -->
      <div id="tab-following" class="d-none">
        <div class="row" id="following-grid">
          <!-- Followings injected -->
        </div>
      </div>

      <!-- Activity -->
      <div id="tab-activity" class="d-none">
        <div class="card">
          <div class="card-body p-0">
            <ul class="todo-list" id="activity-big" data-widget="todo-list">
              <!-- Big activity items injected -->
            </ul>
          </div>
        </div>
      </div>

      <!-- About -->
      <div id="tab-about" class="d-none">
        <div class="card">
          <div class="card-header"><h3 class="card-title mb-0">About Nomad</h3></div>
          <div class="card-body">
            <h5>Who am I?</h5>
            <p id="about-text" class="text-muted mb-4">I’m a software developer focused on excellent developer experience, system design, and resilient UIs. I like turning ambiguous ideas into shipped features.</p>
            <div class="row">
              <div class="col-md-6">
                <h6 class="mb-2 text-muted"><i class="fas fa-toolbox mr-1"></i> Tooling</h6>
                <ul class="list-unstyled small mb-4" id="tooling-list">
                  <!-- Injected -->
                </ul>
              </div>
              <div class="col-md-6">
                <h6 class="mb-2 text-muted"><i class="fas fa-project-diagram mr-1"></i> Interests</h6>
                <div id="interests-wrap">
                  <!-- Chips injected -->
                </div>
              </div>
            </div>
            <button class="btn btn-outline-secondary mt-2" id="btn-edit-about"><i class="fas fa-edit mr-1"></i>Edit About</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="profile-form">
        <div class="modal-header">
          <h5 class="modal-title">Edit Profile</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Display Name</label>
              <input type="text" id="f-name" class="form-control" required>
            </div>
            <div class="form-group col-md-6">
              <label>Headline</label>
              <input type="text" id="f-headline" class="form-control" placeholder="Software Developer">
            </div>
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea id="f-bio" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Location</label>
              <input type="text" id="f-location" class="form-control" placeholder="Earth">
            </div>
            <div class="form-group col-md-6">
              <label>Website</label>
              <input type="url" id="f-website" class="form-control" placeholder="https://nomad.dev">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>GitHub</label>
              <input type="url" id="f-github" class="form-control" placeholder="https://github.com/nomad">
            </div>
            <div class="form-group col-md-6">
              <label>Twitter/X</label>
              <input type="text" id="f-twitter" class="form-control" placeholder="@nomad">
            </div>
          </div>
          <div class="form-group">
            <label>Skills (comma-separated)</label>
            <input type="text" id="f-skills" class="form-control" placeholder="TypeScript, Django, PostgreSQL">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-dismiss="modal" type="button">Cancel</button>
          <button class="btn btn-primary" type="submit"><i class="fas fa-save mr-1"></i>Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add/Edit Course Modal (reused from assets concept) -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="course-form">
        <div class="modal-header">
          <h5 class="modal-title">New Course</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="c-id">
          <div class="form-row">
            <div class="form-group col-md-8">
              <label>Title</label>
              <input type="text" id="c-title" class="form-control" placeholder="e.g. Practical System Design" required>
            </div>
            <div class="form-group col-md-4">
              <label>Category</label>
              <select id="c-category" class="form-control">
                <option>Design</option>
                <option>Development</option>
                <option>Marketing</option>
                <option>Data</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Level</label>
              <select id="c-level" class="form-control">
                <option>Beginner</option>
                <option>Intermediate</option>
                <option>Advanced</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>Duration (min)</label>
              <input type="number" id="c-duration" class="form-control" min="1" value="60">
            </div>
            <div class="form-group col-md-4">
              <label>Thumbnail</label>
              <select id="c-thumb" class="form-control">
                <option value="course-1.jpg">Cover 1</option>
                <option value="course-2.jpg">Cover 2</option>
                <option value="course-3.jpg">Cover 3</option>
                <option value="course-4.jpg">Cover 4</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Tags (comma-separated)</label>
            <input type="text" id="c-tags" class="form-control" placeholder="systems, resilience, scale">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="c-desc" class="form-control" rows="3" placeholder="What learners will get…"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-dismiss="modal" type="button">Cancel</button>
          <button class="btn btn-primary" type="submit"><i class="fas fa-save mr-1"></i>Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
(function(){
  'use strict';

  // ---- Constants & helpers ----
  const STATIC_BASE = "{% static 'dist/img/' %}";
  const KEY = 'nomad.profile.v1';
  const KCOURSES = 'nomad.courses.v1';
  const KFOLLOWING = 'nomad.following.v1';
  const kebab = s => (s||'').toLowerCase().replace(/\s+/g,'-');
  const esc = s => (s||'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const toTags = v => (Array.isArray(v)?v:(v||'').split(',')).map(x=>x.trim()).filter(Boolean);
  const fmtDate = d => {
    const x = new Date(d);
    return isNaN(x) ? '' : `${String(x.getMonth()+1).padStart(2,'0')}/${String(x.getDate()).padStart(2,'0')}/${x.getFullYear()}`;
  };
  const uuid = ()=>'id_'+Math.random().toString(36).slice(2,10);
  const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
  const load = (k,fb)=>{ try{ return JSON.parse(localStorage.getItem(k)) || fb; }catch{ return fb; } };

  // ---- Elements ----
  const $tabs = document.getElementById('profile-tabs');
  const sections = {
    overview: document.getElementById('tab-overview'),
    courses: document.getElementById('tab-courses'),
    following: document.getElementById('tab-following'),
    activity: document.getElementById('tab-activity'),
    about: document.getElementById('tab-about')
  };

  const $displayName = document.getElementById('display-name');
  const $headline = document.getElementById('headline');
  const $username = document.getElementById('username');
  const $bio = document.getElementById('bio');
  const $location = document.getElementById('location');
  const $website = document.getElementById('website');
  const $github = document.getElementById('github');
  const $twitter = document.getElementById('twitter');
  const $skillsWrap = document.getElementById('skills-wrap');

  const $followers = document.getElementById('followers-count');
  const $following = document.getElementById('following-count');
  const $coursesCount = document.getElementById('courses-count');
  const $coursesCountBadge = document.getElementById('courses-count-badge');
  const $featured = document.getElementById('featured-courses');
  const $coursesGrid = document.getElementById('courses-grid');
  const $followingGrid = document.getElementById('following-grid');
  const $activityList = document.getElementById('activity-list');
  const $activityBig = document.getElementById('activity-big');

  const $btnFollow = document.getElementById('btn-follow');
  const $btnEdit = document.getElementById('btn-edit-profile');
  const $btnAddCourse = document.getElementById('btn-add-course');
  const $btnAddCourse2 = document.getElementById('btn-add-course-2');

  // Modals
  const $profileForm = document.getElementById('profile-form');
  const $fName = document.getElementById('f-name');
  const $fHeadline = document.getElementById('f-headline');
  const $fBio = document.getElementById('f-bio');
  const $fLocation = document.getElementById('f-location');
  const $fWebsite = document.getElementById('f-website');
  const $fGithub = document.getElementById('f-github');
  const $fTwitter = document.getElementById('f-twitter');
  const $fSkills = document.getElementById('f-skills');

  // Course modal
  const $courseForm = document.getElementById('course-form');
  const $cId = document.getElementById('c-id');
  const $cTitle = document.getElementById('c-title');
  const $cCat = document.getElementById('c-category');
  const $cLevel = document.getElementById('c-level');
  const $cDur = document.getElementById('c-duration');
  const $cThumb = document.getElementById('c-thumb');
  const $cTags = document.getElementById('c-tags');
  const $cDesc = document.getElementById('c-desc');

  // ---- State ----
  let profile = load(KEY, {
    name: 'Nomad',
    headline: 'Software Developer',
    username: 'nomad',
    bio: 'Curious builder crafting delightful software experiences. Coffee-powered. Remote-first.',
    location: 'Earth',
    website: 'https://nomad.dev',
    github: 'https://github.com/nomad',
    twitter: '@nomad',
    skills: ['TypeScript','React','Django','PostgreSQL','Docker','CI/CD'],
    followers: 128,
    isFollowing: false,
    interests: ['DX','System Design','Resilience','Observability','Web Performance'],
    tooling: ['VS Code','Neovim','Docker','GitHub Actions','Vite','Poetry']
  });

  let courses = load(KCOURSES, [
    { id:uuid(), title:'Design Systems in Practice', category:'Design', level:'Intermediate', duration:120, tags:['ux','figma'], thumb:'course-1.jpg', description:'Build robust design systems.', updated:new Date().toISOString() },
    { id:uuid(), title:'Intro to Modern Frontend', category:'Development', level:'Beginner', duration:90, tags:['js','html','css'], thumb:'course-2.jpg', description:'Today’s frontend landscape.', updated:new Date().toISOString() },
    { id:uuid(), title:'API Craft for Devs', category:'Development', level:'Advanced', duration:110, tags:['api','rest','design'], thumb:'course-3.jpg', description:'Designing pragmatic APIs.', updated:new Date().toISOString() }
  ]);

  let following = load(KFOLLOWING, [
    { id:uuid(), name:'Ava', handle:'@ava', role:'Product Designer', avatar:'avatar2.png' },
    { id:uuid(), name:'Leo', handle:'@leo', role:'Full-stack Dev', avatar:'avatar3.png' },
    { id:uuid(), name:'Mia', handle:'@mia', role:'Data Eng', avatar:'avatar4.png' },
    { id:uuid(), name:'Kai', handle:'@kai', role:'SRE', avatar:'avatar5.png' }
  ]);

  // ---- Renderers ----
  function chip(txt){ return `<span class="badge badge-light border mr-1 mb-1">${esc(txt)}</span>`; }
  function thumbUrl(n){ return STATIC_BASE + (n||'placeholder.png'); }
  function avatarUrl(n){ return STATIC_BASE + (n||'avatar.png'); }

  function renderHeader(){
    document.getElementById('display-name').textContent = profile.name;
    document.getElementById('headline').textContent = profile.headline || 'Software Developer';
    document.getElementById('username').textContent = '@' + (profile.username||'nomad');
    document.getElementById('bio').textContent = profile.bio || '';
    document.getElementById('location').textContent = profile.location || '—';
    const $w = document.getElementById('website'); $w.textContent = profile.website||''; $w.href = profile.website||'#';
    const $g = document.getElementById('github'); $g.textContent = (profile.github||'').replace(/^https?:\/\//,''); $g.href = profile.github||'#';
    const $t = document.getElementById('twitter'); $t.textContent = profile.twitter||''; $t.href = profile.twitter ? ('https://x.com/'+profile.twitter.replace('@','')) : '#';
    $followers.textContent = profile.followers || 0;
    $following.textContent = following.length;
    $coursesCount.textContent = courses.length;
    $coursesCountBadge.textContent = `${courses.length} courses`;
    // skills
    $skillsWrap.innerHTML = (profile.skills||[]).map(chip).join('') || '<span class="text-muted">No skills yet</span>';
    // follow button state
    $btnFollow.classList.toggle('btn-primary', !profile.isFollowing);
    $btnFollow.classList.toggle('btn-secondary', profile.isFollowing);
    $btnFollow.querySelector('span').textContent = profile.isFollowing ? 'Following' : 'Follow';
    $btnFollow.querySelector('i').className = profile.isFollowing ? 'fas fa-check mr-1' : 'fas fa-user-plus mr-1';
  }

  function courseCard(c){
    const tags = toTags(c.tags).map(chip).join('');
    return `
    <div class="col-xl-4 col-md-6 col-12 mb-3" data-id="${c.id}">
      <div class="card h-100 shadow-sm">
        <img class="card-img-top" src="${thumbUrl(c.thumb)}" alt="">
        <div class="card-body d-flex flex-column">
          <h5 class="mb-1">${esc(c.title)}</h5>
          <div class="text-muted small mb-2">${esc(c.category)} • ${esc(c.level)} • ${c.duration||0} min</div>
          <p class="text-muted flex-grow-1">${esc(c.description||'')}</p>
          <div>${tags}</div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted">Updated ${fmtDate(c.updated)}</small>
            <div class="btn-group">
              <button class="btn btn-sm btn-primary js-view"><i class="fas fa-eye"></i></button>
              <button class="btn btn-sm btn-info js-edit"><i class="fas fa-pencil-alt"></i></button>
              <button class="btn btn-sm btn-danger js-del"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  }

  function renderOverview(){
    // featured: top 2 by recent
    const featured = [...courses].sort((a,b)=>new Date(b.updated)-new Date(a.updated)).slice(0,2);
    document.getElementById('featured-courses').innerHTML = featured.map(courseCard).join('') || '<div class="col-12 text-muted">No courses yet.</div>';
    // recent activity (compact)
    const items = [
      { icon:'fas fa-book', text:`Published “${(courses[0]||{}).title||'New Course'}”`, time:'2d' },
      { icon:'fas fa-user-plus', text:`Followed ${(following[0]||{}).name||'Ava'}`, time:'3d' },
      { icon:'fas fa-pen', text:'Updated profile headline', time:'5d' }
    ];
    $activityList.innerHTML = items.map(i=>`
      <li class="item">
        <div class="product-img">
          <span class="img-circle elevation-2 d-inline-flex align-items-center justify-content-center bg-light" style="width:40px;height:40px;"><i class="${i.icon} text-muted"></i></span>
        </div>
        <div class="product-info">
          <span class="product-title">${esc(i.text)}<span class="badge badge-light float-right">${esc(i.time)}</span></span>
          <span class="product-description text-muted">Nomad</span>
        </div>
      </li>
    `).join('');
  }

  function renderCourses(){
    $coursesGrid.innerHTML = courses.map(courseCard).join('') || '<div class="col-12 text-muted">No courses yet.</div>';
  }

  function renderFollowing(){
    $followingGrid.innerHTML = following.map(f=>`
      <div class="col-xl-3 col-lg-4 col-md-6 col-12 mb-3" data-id="${f.id}">
        <div class="card h-100 text-center">
          <div class="card-body">
            <img class="img-circle mb-2" src="${avatarUrl(f.avatar)}" alt="" style="width:72px; height:72px; object-fit:cover;">
            <h5 class="mb-0">${esc(f.name)}</h5>
            <div class="text-muted small">${esc(f.role)}</div>
            <div class="text-muted small">${esc(f.handle)}</div>
            <div class="mt-2">
              <button class="btn btn-xs btn-outline-secondary js-unfollow"><i class="fas fa-user-times mr-1"></i>Unfollow</button>
            </div>
          </div>
        </div>
      </div>
    `).join('') || '<div class="col-12 text-muted">No followings yet.</div>';
  }

  function renderActivityBig(){
    const items = [
      { text:'Reviewed PR: Improve build pipeline', done:true },
      { text:'Drafted “Resilient UIs” outline', done:false },
      { text:'Recorded lesson: “API Craft for Devs”', done:true }
    ];
    $activityBig.innerHTML = items.map(i=>`
      <li data-id="${uuid()}">
        <span class="handle ui-sortable-handle"><i class="fas fa-ellipsis-v"></i><i class="fas fa-ellipsis-v"></i></span>
        <div class="icheck-primary d-inline ml-2">
          <input type="checkbox" ${i.done?'checked':''}>
          <label></label>
        </div>
        <span class="text">${esc(i.text)}</span>
        <small class="badge badge-${i.done?'success':'warning'}"><i class="far fa-clock"></i> ${i.done?'done':'pending'}</small>
        <div class="tools"><i class="fas fa-edit"></i><i class="fas fa-trash-o"></i></div>
      </li>
    `).join('');
  }

  function renderAbout(){
    const tooling = (profile.tooling||[]).map(t=>`<li class="mb-1"><i class="fas fa-check text-success mr-2"></i>${esc(t)}</li>`).join('');
    document.getElementById('tooling-list').innerHTML = tooling || '<li class="text-muted">No tooling listed</li>';
    document.getElementById('interests-wrap').innerHTML = (profile.interests||[]).map(chip).join('') || '<span class="text-muted">No interests yet</span>';
  }

  function renderAll(){
    renderHeader();
    renderOverview();
    renderCourses();
    renderFollowing();
    renderActivityBig();
    renderAbout();
  }

  // ---- Tabs ----
  $tabs.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-tab]');
    if (!a) return;
    e.preventDefault();
    $tabs.querySelectorAll('a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    const tab = a.getAttribute('data-tab');
    Object.entries(sections).forEach(([k,el])=> el.classList.toggle('d-none', k!==tab));
  });
  // “See all courses” links
  document.addEventListener('click', (e)=>{
    const j = e.target.closest('[data-tab-jump="courses"]');
    if (!j) return;
    e.preventDefault();
    $tabs.querySelector('[data-tab="courses"]').click();
  });

  // ---- Follow / Unfollow ----
  $btnFollow.addEventListener('click', ()=>{
    profile.isFollowing = !profile.isFollowing;
    profile.followers = Math.max(0, (profile.followers||0) + (profile.isFollowing?1:-1));
    save(KEY, profile);
    renderHeader();
  });

  // ---- Edit Profile ----
  document.getElementById('btn-edit-profile').addEventListener('click', ()=>{
    $fName.value = profile.name||'';
    $fHeadline.value = profile.headline||'';
    $fBio.value = profile.bio||'';
    $fLocation.value = profile.location||'';
    $fWebsite.value = profile.website||'';
    $fGithub.value = profile.github||'';
    $fTwitter.value = profile.twitter||'';
    $fSkills.value = (profile.skills||[]).join(', ');
    $('#editProfileModal').modal('show');
  });

  $profileForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    profile.name = $fName.value.trim() || 'Nomad';
    profile.headline = $fHeadline.value.trim() || 'Software Developer';
    profile.bio = $fBio.value.trim();
    profile.location = $fLocation.value.trim();
    profile.website = $fWebsite.value.trim();
    profile.github = $fGithub.value.trim();
    profile.twitter = $fTwitter.value.trim();
    profile.skills = toTags($fSkills.value);
    save(KEY, profile);
    renderHeader();
    $('#editProfileModal').modal('hide');
  });

  // ---- Courses CRUD ----
  function openCourseModal(data=null){
    $courseForm.reset();
    document.querySelector('#courseModal .modal-title').textContent = data ? 'Edit Course' : 'New Course';
    $cId.value = data ? data.id : '';
    $cTitle.value = data ? (data.title||'') : '';
    $cCategory.value = data ? (data.category||'Development') : 'Development';
    $cLevel.value = data ? (data.level||'Beginner') : 'Beginner';
    $cDuration.value = data ? (data.duration||60) : 60;
    $cThumb.value = data ? (data.thumb||'course-1.jpg') : 'course-1.jpg';
    $cTags.value = data ? (toTags(data.tags).join(',')) : '';
    $cDesc.value = data ? (data.description||'') : '';
    $('#courseModal').modal('show');
  }

  [$btnAddCourse, $btnAddCourse2].forEach(btn=>{
    if (!btn) return;
    btn.addEventListener('click', ()=> openCourseModal());
  });

  document.addEventListener('click', (e)=>{
    const card = e.target.closest('[data-id]');
    if (!card) return;
    const id = card.getAttribute('data-id');
    const c = courses.find(x=>x.id===id);
    if (!c) return;

    if (e.target.closest('.js-view')) {
      alert(`${c.title}\n${c.category} • ${c.level} • ${c.duration} min\nTags: ${toTags(c.tags).join(', ')||'—'}`);
    }
    if (e.target.closest('.js-edit')) {
      openCourseModal(c);
    }
    if (e.target.closest('.js-del')) {
      if (confirm(`Delete “${c.title}”?`)) {
        courses = courses.filter(x=>x.id!==id);
        save(KCOURSES, courses);
        renderAll();
      }
    }
  });

  $courseForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const obj = {
      id: $cId.value || uuid(),
      title: $cTitle.value.trim(),
      category: $cCat.value,
      level: $cLevel.value,
      duration: +$cDur.value||60,
      thumb: $cThumb.value,
      tags: toTags($cTags.value),
      description: $cDesc.value.trim(),
      updated: new Date().toISOString()
    };
    if (!obj.title) { $cTitle.focus(); return; }
    const i = courses.findIndex(x=>x.id===obj.id);
    if (i===-1) courses.push(obj); else courses[i]=obj;
    save(KCOURSES, courses);
    renderAll();
    $('#courseModal').modal('hide');
  });

  // ---- Following (unfollow) ----
  document.getElementById('tab-following').addEventListener('click', (e)=>{
    const btn = e.target.closest('.js-unfollow');
    if (!btn) return;
    const box = e.target.closest('[data-id]');
    const id = box.getAttribute('data-id');
    const f = following.find(x=>x.id===id);
    if (!f) return;
    if (confirm(`Unfollow ${f.name}?`)) {
      following = following.filter(x=>x.id!==id);
      save(KFOLLOWING, following);
      renderHeader();
      renderFollowing();
    }
  });

  // ---- Init ----
  function init(){
    renderAll();
  }
  init();

})();
</script>
{% endblock extra_scripts %}

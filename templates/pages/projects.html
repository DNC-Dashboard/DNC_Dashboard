{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Projects {% endblock title %}
{% block bodyclass %} hold-transition sidebar-mini {% endblock bodyclass %}

{% block content %}
<div class="content-wrapper">

  <!-- Header -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2 align-items-center">
        <div class="col-sm-6">
          <h1>Projects</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right mb-0">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">Projects</li>
          </ol>
        </div>
      </div>

      <!-- top actions -->
      <div class="row g-2">
        <div class="col-md-4 col-12">
          <input id="proj-search" type="search" class="form-control" placeholder="Search projects…">
        </div>
        <div class="col-md-8 col-12 text-md-right mt-2 mt-md-0">
          <button id="btn-new" class="btn btn-primary">
            <i class="fas fa-plus mr-1"></i> New Project
          </button>
          <button id="btn-reset" class="btn btn-outline-secondary ml-2">
            <i class="fas fa-undo mr-1"></i> Reset Demo Data
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <h3 class="card-title mb-0">Projects</h3>
        <div class="card-tools ml-auto">
          <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
            <i class="fas fa-minus"></i>
          </button>
          <button type="button" class="btn btn-tool" data-card-widget="remove" title="Remove">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- ⚠️ CHANGED: table -> grid -->
      <div class="card-body">
        <div id="projects-grid" class="row"></div>
      </div>
    </div>
  </section>
</div>

<!-- Modal: Add/Edit -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="project-form">
        <div class="modal-header">
          <h5 class="modal-title" id="projectModalLabel">New Project</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="proj-id">

          <div class="form-row">
            <div class="form-group col-md-8">
              <label for="proj-name">Project name</label>
              <input type="text" id="proj-name" class="form-control" required>
            </div>
            <div class="form-group col-md-4">
              <label for="proj-created">Created date</label>
              <input type="date" id="proj-created" class="form-control" required>
            </div>
          </div>

          <!-- NEW: Description -->
          <div class="form-group">
            <label for="proj-desc">Short description</label>
            <textarea id="proj-desc" rows="2" class="form-control" placeholder="Short description of project…"></textarea>
          </div>

          <!-- NEW: Task counters to match wireframe -->
          <div class="form-row">
            <div class="form-group col-md-4">
              <label for="proj-tasks">Tasks (total)</label>
              <input type="number" id="proj-tasks" class="form-control" min="0" step="1" value="0">
            </div>
            <div class="form-group col-md-4">
              <label for="proj-open">Open</label>
              <input type="number" id="proj-open" class="form-control" min="0" step="1" value="0">
            </div>
            <div class="form-group col-md-4">
              <label for="proj-overdue">Overdue</label>
              <input type="number" id="proj-overdue" class="form-control" min="0" step="1" value="0">
            </div>
          </div>

          <!-- keep notes if you want -->
          <div class="form-group">
            <label for="proj-notes">Notes (optional)</label>
            <textarea id="proj-notes" rows="3" class="form-control"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save mr-1"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- light styling to resemble the wireframe boxes -->
<style>
  .wf-card {
    border: 2px solid #222;
    border-radius: 6px;
    background: #fff;
    padding: 16px;
    margin-bottom: 24px;
  }
  .wf-card h5 a.view-link { font-weight: 600; }
  .wf-card h5 small { font-weight: 400; }
  .wf-muted { color: #6c757d; }
</style>
{% endblock content %}

{% block extra_scripts %}
<script>
(function () {
  'use strict';

  // ---------- Config / Utilities ----------
  const STORAGE_KEY = 'projects.v2.wireframe';
  const $grid   = document.getElementById('projects-grid');
  const $search = document.getElementById('proj-search');
  const $btnNew = document.getElementById('btn-new');
  const $btnReset = document.getElementById('btn-reset');

  let state = {
    projects: [],
    filter: '' // search text
  };

  const uuid = () => 'p_' + Math.random().toString(36).slice(2, 10);
  const esc = (s) => (s || '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtDate = (iso) => {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;
  };
  const clamp0 = (n) => Math.max(0, parseInt(n || 0, 10));

  // ---------- Persistence ----------
  const load = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } };
  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state.projects));

  function ensureSeed() {
    if (state.projects.length) return;
    state.projects = [
      {
        id: uuid(),
        name: 'Group 43',
        created: '2025-10-01',
        desc: 'Dashboard creation and demo setup.',
        tasks: 24, open: 8, overdue: 2,
        notes: ''
      },
      {
        id: uuid(),
        name: 'Marketing Launch',
        created: '2019-01-01',
        desc: 'Campaign assets, timelines and landing pages.',
        tasks: 10, open: 3, overdue: 1,
        notes: ''
      },
      {
        id: uuid(),
        name: 'Website Revamp',
        created: '2019-01-01',
        desc: 'Redesign with new brand components.',
        tasks: 24, open: 8, overdue: 2,
        notes: ''
      }
    ];
    save();
  }

  // ---------- Rendering (grid of cards) ----------
  function render() {
    const q = (state.filter || '').toLowerCase();
    let rows = [...state.projects];

    if (q) {
      rows = rows.filter(p =>
        [p.name, p.desc, p.notes].join(' ').toLowerCase().includes(q)
      );
    }

    $grid.innerHTML = rows.map(p => `
      <div class="col-lg-6 col-md-6 col-12">
        <div class="wf-card" data-id="${p.id}">
          <h5 class="mb-2">
            ${esc(p.name)} <a href="#" class="view-link js-view">[View]</a>
            <br><small class="wf-muted">Created ${esc(fmtDate(p.created))}</small>
          </h5>
          <p class="wf-muted mb-3">${esc(p.desc || 'Short description of project…')}</p>
          <p class="mb-0">
            <strong>Tasks:</strong> ${clamp0(p.tasks)} &nbsp; | &nbsp;
            <strong>Open:</strong> ${clamp0(p.open)} &nbsp; | &nbsp;
            <strong>Overdue:</strong> ${clamp0(p.overdue)}
          </p>
          <div class="mt-3">
            <button class="btn btn-sm btn-outline-primary js-edit">Edit</button>
            <button class="btn btn-sm btn-outline-danger js-del">Delete</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  // ---------- Modal logic ----------
  const $modal = document.getElementById('projectModal');
  const $form  = document.getElementById('project-form');
  const $id    = document.getElementById('proj-id');
  const $name  = document.getElementById('proj-name');
  const $created = document.getElementById('proj-created');
  const $desc = document.getElementById('proj-desc');
  const $tasks = document.getElementById('proj-tasks');
  const $open  = document.getElementById('proj-open');
  const $overdue = document.getElementById('proj-overdue');
  const $notes = document.getElementById('proj-notes');
  const $modalLabel = document.getElementById('projectModalLabel');

  function openModal(mode = 'new', data = null) {
    $form.reset();
    $id.value = '';
    const today = new Date().toISOString().slice(0,10);
    $created.value = today;
    $modalLabel.textContent = mode === 'edit' ? 'Edit Project' : 'New Project';

    if (mode === 'edit' && data) {
      $id.value = data.id;
      $name.value = data.name || '';
      $created.value = data.created || today;
      $desc.value = data.desc || '';
      $tasks.value = clamp0(data.tasks);
      $open.value = clamp0(data.open);
      $overdue.value = clamp0(data.overdue);
      $notes.value = data.notes || '';
    }

    $('#projectModal').modal('show');
  }

  $form.addEventListener('submit', (e) => {
    e.preventDefault();

    // sanity: open + overdue <= tasks
    const t = clamp0($tasks.value);
    const o = clamp0($open.value);
    const od = clamp0($overdue.value);
    if (o + od > t) {
      alert('Open + Overdue cannot exceed Total Tasks.');
      return;
    }

    const data = {
      id: $id.value || uuid(),
      name: ($name.value || '').trim(),
      created: $created.value,
      desc: ($desc.value || '').trim(),
      tasks: t, open: o, overdue: od,
      notes: ($notes.value || '').trim()
    };
    if (!data.name) { $name.focus(); return; }

    const i = state.projects.findIndex(p => p.id === data.id);
    if (i === -1) state.projects.push(data); else state.projects[i] = data;

    save();
    render();
    $('#projectModal').modal('hide');
  });

  // ---------- Events ----------
  $btnNew.addEventListener('click', () => openModal('new'));
  $btnReset.addEventListener('click', () => {
    if (!confirm('Reset to demo data? This will overwrite current local changes.')) return;
    localStorage.removeItem(STORAGE_KEY);
    state.projects = [];
    ensureSeed();
    render();
  });

  $search.addEventListener('input', (e) => {
    state.filter = e.target.value || '';
    render();
  });

  // grid action buttons
  document.getElementById('projects-grid').addEventListener('click', (e) => {
    const btn = e.target.closest('button, a');
    if (!btn) return;
    const card = e.target.closest('.wf-card');
    if (!card) return;
    const id = card.getAttribute('data-id');
    const proj = state.projects.find(p => p.id === id);
    if (!proj) return;

    if (btn.classList.contains('js-view')) {
      const info = [
        `Name: ${proj.name}`,
        `Created: ${fmtDate(proj.created)}`,
        `Tasks: ${clamp0(proj.tasks)} | Open: ${clamp0(proj.open)} | Overdue: ${clamp0(proj.overdue)}`,
        proj.desc ? `Description: ${proj.desc}` : '',
        proj.notes ? `Notes: ${proj.notes}` : ''
      ].filter(Boolean).join('\n');
      alert(info);
      e.preventDefault();
    }

    if (btn.classList.contains('js-edit')) {
      openModal('edit', proj);
      e.preventDefault();
    }

    if (btn.classList.contains('js-del')) {
      if (confirm(`Delete project "${proj.name}"?`)) {
        state.projects = state.projects.filter(p => p.id !== id);
        save();
        render();
      }
      e.preventDefault();
    }
  });

  // ---------- Init ----------
  (function init() {
    state.projects = load();
    ensureSeed();
    render();
  })();

})();
</script>
{% endblock extra_scripts %}
